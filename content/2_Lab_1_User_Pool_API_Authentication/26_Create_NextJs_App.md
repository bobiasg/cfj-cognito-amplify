---
title: "Nextjs App With NextAuth" # MODIFY THIS TITLE
chapter: true
weight: 6 # MODIFY THIS VALUE TO REFLECT THE ORDERING OF THE MODULES
---

<!-- MORE SUBMODULES CAN BE ADDED TO DIVIDE UP THE SETUP INTO SMALLER SECTIONS -->
<!-- COPY AND PASTE THIS SUBMODULE FILE, RENAME, AND CHANGE THE CONTENTS AS NECESSARY -->

# Nextjs App With NextAuth

## Create NextJs App

To get started, we first need to create a new Next.js project.

`
 $ npx create-next-app@latest  cfj-cognito
`

Now change into the new app directory & install some dependencies

`
npm install next-auth@beta
`

## Configure NextAuth

Create auth secret, it will add AUTH_SECRET to .env.local

`
npx auth secret
`

Create file auth.ts in folder libs, place the follwing content inside:

```js
import NextAuth from "next-auth";
import CognitoProvider from "next-auth/providers/cognito";
 
export const { handlers, signIn, signOut, auth } = NextAuth({
  // Configure one or more authentication providers
  providers: [
    CognitoProvider({
      clientId: process.env.COGNITO_CLIENT_ID,
      clientSecret: process.env.COGNITO_CLIENT_SECRET,
      issuer: process.env.COGNITO_ISSUER,
    }),
  ],
})
```

Create file route.ts in folder named app/api/auth/[...nextauth] with content:
```js
import {handlers} from '@/libs/auth';

export const {GET, POST} = handlers;

```

As you can observe in the code snippet, all sensitive information is stored in an .env.local file. This practice is essential to prevent exposure of such details to the front-end users of our application. COGNITO_CLIENT_ID, COGNITO_CLIENT_SECRET get from App Client Setting in Cognito User Pool.

First, go back to AWS -> Cognito and select "CFJ-01" pool.

Click on the App integration tab and scroll to the bottom. You will see the App client list. Great! Here, you should find your "cfj-client". Click on it. This is the place where you want to be:
![NextApp](/images/80-nextjs-01.png)


The issuer is a URL, that looks like this: https://cognito-idp.{region}.amazonaws.com/{PoolId}, where PoolId is from General Settings in Cognito
![NextApp](/images/81-nextjs-02.png)

## Implementing User Authentication

This section is extra, so enjoy it! First, create a new file inside app called auth-provider.tsx and put the following code inside:

```js
"use client";

import { SessionProvider } from "next-auth/react";

export default function AuthProvider({ children }: { children: React.ReactNode }) {
  return <SessionProvider>{children}</SessionProvider>;
}
```

Update app/layout.tsx
```js
import type { Metadata } from "next";
import { Inter } from "next/font/google";
import "./globals.css";
import AuthProvider from "@/components/auth-provider";
import Header from "@/components/header";
import Footer from "@/components/footer";

const inter = Inter({ subsets: ["latin"] });

export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
    <body className={inter.className}>
      <div className="flex flex-col justify-between w-full h-full min-h-screen">
        <Header />
        <AuthProvider>
        <main className="flex-auto w-full max-w-3xl px-4 py-4 mx-auto sm:px-6 md:py-6">
          {children}
        </main>
        </AuthProvider>
        <Footer />
      </div>
    </body>
  </html>

  );
}

```

Update app/page.tsx
```js
import { auth } from "@/libs/auth"

export default async function Index() {
  const session = await auth()

  return (
    <div className="flex flex-col gap-6">
      <h1 className="text-3xl font-bold">NextAuth.js Example</h1>
      <div>
        This is an example site to demonstrate how to use NextAuth with Cognito
      </div>
      <div className="flex flex-col bg-gray-100 rounded-md">
        <div className="p-4 font-bold bg-gray-200 rounded-t-md">
          Current Session
        </div>
        <pre className="py-6 px-4 whitespace-pre-wrap break-all">
          {JSON.stringify(session, null, 2)}
        </pre>
      </div>
    </div>
  )
}
```

{{% notice note %}}
For make some styles on app, I add more components and library. I can access code at .......
{{% /notice %}}


## Testing

To run app in https mode, update package.json in scripts tag:

`
"dev": "next dev --experimental-https",
`

Run app

`
npm run dev
`

It open page in browser at https://localhost:3000
![NextApp](/images/90-nextjs-10.png)

Click "Sign In", and click "Sign in with Cognito", browser will be redirect to hosted UI site. 
![NextApp](/images/91-nextjs-11.png)

But now, we got error by redirect missmatch.
![NextApp](/images/92-nextjs-12.png)

Go to Hosted UI setting to update callback Url. Add new callback url: https://localhost:3000/api/auth/callback/cognito 
![NextApp](/images/93-nextjs-13.png)

We will access test app again at https://localhost:3000, click "Sign In", and click "Sign In with Cognito" to process authentication at Hosted UI site
![NextApp](/images/94-nextjs-14.png)

Enter your crendentials, after authenticated, browser will be redirect to https://localhost:3000 
![NextApp](/images/95-nextjs-15.png)

<!-- 
{{% notice note %}}

{{% /notice %}}


{{% notice warning %}}
There is currently an issue when using NextAuth with Cognito with the following method: when signing out, the Next.js app will perform the sign out (clear cookies/tokens); however, the Hosted UI site still retains the token. When the user tries to sign in again, the Hosted UI site will use that token instead of displaying the login form. We will replace Next Auth with AWS Amplify library to check it.
{{% /notice %}} 
-->




